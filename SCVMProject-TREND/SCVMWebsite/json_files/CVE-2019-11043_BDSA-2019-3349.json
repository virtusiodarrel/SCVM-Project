{
    "source": "BDSA",
    "name": "BDSA-2019-3349",
    "title": "PHP Vulnerable to Remote Code Execution (RCE) via Integer Underflow in 'init_request_info' Function",
    "description": "PHP7 is vulnerable to remote code execution (RCE) due to the improper management of system memory resources. A remote attacker could execute arbitrary commands on the underlying operating system by submitting crafted requests to an affected server. It should be noted that this vulnerability only exists whenever FPM (FastCGI Process Manager) is enabled within NGINX deployments.\n\nThis vulnerability is listed as exploitable by the Cybersecurity & Infrastructure Security Agency in their [Known Exploited Vulnerabilities Catalog](https://www.cisa.gov/known-exploited-vulnerabilities-catalog).",
    "technicalDescription": "The function `init_request_info()`, which is defined within the script `fpm_main.c`, contains code  that is used to initialize the `request_info` structure. This initialization involves parsing and translating a variety of environmental variables, including `PATH_INFO` and `SCRIPT_FILENAME`. Within an NGINX deployment, these environmental variables are dynamically set using client-provided input, according to the information that is specified in the NGINX configuration file. The `fastcgi_split_path_info` directive that is specified within this file utilizes a regular expression in order to parse the client-supplied URI parameters and then assign the parsed values to the aforementioned environmental variables.\n\nInside the `init_request_info()` function, a pointer to the string associated with the `PATH_INFO` environmental variable is extracted and assigned to the variable `env_path_info` via the function `FCGI_GETENV()`.  This variable is then used in order to set the value of the `path_info` variable via a ternary conditional statement. If the value of `env_path_info` is set, then the pointer arithmetic `env_path_info + pilen - slen` is performed so that `path_info` will point to the start of the relevant file path. The value of the variable `pilen` is simply the length of the string pointed to by `env_path_info`. However, this arithmetic assumes that the string pointed to by `env_path_info` is prefixed with the correct path, and that `PATH_INFO` is not empty. No validation is performed to ensure this. As a consequence of this, if `PATH_INFO` is empty, the aforementioned arithmetic will underflow and will return a pointer to a memory address that does not correspond to the beginning of the target string. `PATH_INFO` can be made to be empty by supplying a crafted URI that contains a newline character, which essentially breaks the pattern matching that is attempted by the `fastcgi_split_path_info` directive.\n\nThe consequence of this flawed arithmetic is that an attacker can control the value of the pointer that is calculated, by using a carefully crafted URI. As the function will later call `FCGI_PUTENV()` to write the script path to a memory location associated with this pointer, the attacker can potentially overwrite important environmental information. If FastCGI is being used within an NGINX deployment, then the `_fcgi_data_seg` structure will exist in memory in order to store variables that are used by FastCGI Process Manager (FPM). The attacker could then overwrite the `PHP_VALUE` Fast CGI variable with certain configuration values. These configuration values could allow them to execute arbitrary code on the underlying operating system by submitting crafted web requests that will leverage the system's PHP interpreter. It should be noted that this vulnerability only exists whenever the server implements the required environment. This environment arises whenever  FPM is enabled within NGINX deployments, and the `fastcgi_split_path_info` directive is employed with the necessary regular expression.",
    "publishedDate": "2019-10-29T00:41:30.444Z",
    "updatedDate": "2022-05-06T15:07:11.489Z",
    "disclosureDate": "2019-10-24T00:00:00.000Z",
    "exploitPublishDate": "2019-10-24T00:00:00.000Z",
    "solution": "Fixed by [this](https://github.com/php/php-src/commit/ab061f95ca966731b1c84cf5b7b20155c0a1c06a) commit in versions:\n* [**7.1.33**](https://www.php.net/downloads.php)\n* [**7.2.24**](https://www.php.net/downloads.php)\n* [**7.3.11**](https://www.php.net/downloads.php)",
    "severity": "CRITICAL",
    "cvss2": {
        "baseScore": 7.5,
        "impactSubscore": 6.4,
        "exploitabilitySubscore": 10.0,
        "severity": "MEDIUM",
        "accessVector": "NETWORK",
        "accessComplexity": "LOW",
        "authentication": "NONE",
        "confidentialityImpact": "PARTIAL",
        "integrityImpact": "PARTIAL",
        "availabilityImpact": "PARTIAL",
        "temporalMetrics": {
            "exploitability": "HIGH",
            "remediationLevel": "OFFICIAL_FIX",
            "reportConfidence": "CONFIRMED",
            "score": 6.5
        },
        "vector": "(AV:N/AC:L/Au:N/C:P/I:P/A:P/E:H/RL:OF/RC:C)"
    },
    "cvss3": {
        "baseScore": 10.0,
        "impactSubscore": 6.0,
        "exploitabilitySubscore": 3.9,
        "severity": "CRITICAL",
        "attackVector": "NETWORK",
        "attackComplexity": "LOW",
        "confidentialityImpact": "HIGH",
        "integrityImpact": "HIGH",
        "availabilityImpact": "HIGH",
        "privilegesRequired": "NONE",
        "scope": "CHANGED",
        "userInteraction": "NONE",
        "temporalMetrics": {
            "exploitability": "HIGH",
            "remediationLevel": "OFFICIAL_FIX",
            "reportConfidence": "CONFIRMED",
            "score": 9.5
        },
        "vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H/E:H/RL:O/RC:C"
    },
    "useCvss3": true,
    "classifications": [],
    "zeroDay": false,
    "underReview": false,
    "parentAdvisory": false,
    "credit": "d90pwn, Emil Lerner, beched",
    "workaround": "Add the following line to the FastCGI configuration file to conditionally set the PATH_INFO if it's not empty:\n`fastcgi_param PATH_INFO $fastcgi_path_info if_not_empty;`\n\nLeverage Firewall technology to block control characters `%0a`.",
    "vendorFixDate": "2019-10-24T00:00:00.000Z",
    "vendorNotifiedDate": "2019-09-26T00:00:00.000Z",
    "bdsaTags": [
        "RCE"
    ],
    "overallScore": 9.5,
    "_meta": {
        "allow": [
            "GET"
        ],
        "href": "https://trendmicro2.app.blackduck.com/api/vulnerabilities/BDSA-2019-3349",
        "links": [
            {
                "rel": "cwes",
                "href": "https://trendmicro2.app.blackduck.com/api/cwes/CWE-20"
            },
            {
                "rel": "related-vulnerability",
                "href": "https://trendmicro2.app.blackduck.com/api/vulnerabilities/CVE-2019-11043",
                "label": "NVD"
            },
            {
                "rel": "bdsa-ranges",
                "href": "https://trendmicro2.app.blackduck.com/api/vulnerabilities/BDSA-2019-3349/ranges"
            },
            {
                "rel": "reference",
                "href": "https://bugs.php.net/bug.php?id=78599",
                "label": "ADVISORY"
            },
            {
                "rel": "reference",
                "href": "https://github.com/jas502n/CVE-2019-11043",
                "label": "EXPLOIT"
            },
            {
                "rel": "reference",
                "href": "https://github.com/neex/phuip-fpizdam",
                "label": "EXPLOIT"
            },
            {
                "rel": "reference",
                "href": "https://github.com/neex/phuip-fpizdam",
                "label": "WORKAROUND"
            },
            {
                "rel": "reference",
                "href": "https://github.com/php/php-src/commit/ab061f95ca966731b1c84cf5b7b20155c0a1c06a",
                "label": "PATCH"
            },
            {
                "rel": "reference",
                "href": "https://www.cisa.gov/known-exploited-vulnerabilities-catalog",
                "label": "EXPLOIT"
            },
            {
                "rel": "reference",
                "href": "https://www.php.net/ChangeLog-7.php",
                "label": "ADVISORY"
            },
            {
                "rel": "reference",
                "href": "https://www.php.net/downloads.php",
                "label": "VENDOR_UPGRADE"
            },
            {
                "rel": "default-remediation-status",
                "href": "https://trendmicro2.app.blackduck.com/api/vulnerabilities/BDSA-2019-3349/default-remediation-status"
            }
        ]
    }
}