{
    "source": "BDSA",
    "name": "BDSA-2019-0250",
    "title": "PHP Vulnerable to Remote Code Execution (RCE) via Out-of-bounds Write in 'gdImageColorMatch()' Function",
    "description": "PHP is vulnerable to remote code execution (RCE) due to incorrect buffer bounds calculation in an image color matching function. An attacker who is able to supply crafted image data to a PHP application can inject up to 1200 arbitrary bytes into memory. When combined with a separate vulnerability that would give the attacker an insight into the memory layout on the system this can be leveraged for arbitrary code execution.",
    "technicalDescription": "This flaw lies in the `gdImageColorMatch()` function of the `/ext/gd/libgd/gd_color.c` source file. An unsafe way of calculating the memory required for the `buf` buffer may allow an attacker to perform an out-of-bounds write. The current way of allocating the dynamic buffer is vulnerable to tampering as `im2->colorsTotal` is under the control of an attacker:\n\n```\nbuf = (unsigned long *)safe_emalloc(sizeof(unsigned long), 5 * im2->colorsTotal, 0);\n```\n\nThe attacker can leverage this fact to force an allocation of a buffer as small as 40 bytes by allocating only one color to the second image. This buffer is subsequently filled in a for loop. One of the operations within the loop, used to calculate the buffer pointer, can also be manipulated by an attacker who can modify the `color` value:\n\n```\nbp = buf + (color * 5);\n```\n\nSince it is of a `char` type it can be set to up to 255 which will make `bp` point to `buf + 1275`.  Considering the buffer is only 40 bytes in length this will lead to an out-of-bounds write of attacker-controllable data. This will at the very least result in a crash and denial-of-service (DoS) but may also allow remote code execution provided the attacker has knowledge of the memory layout.",
    "publishedDate": "2019-01-30T16:52:33.678Z",
    "updatedDate": "2019-02-28T13:41:28.848Z",
    "disclosureDate": "2019-01-10T00:00:00.000Z",
    "exploitPublishDate": "2019-01-10T00:00:00.000Z",
    "solution": "Fixed in:\n* [**5.6.40**](http://php.net/downloads.php),\n* [**7.1.26**](http://php.net/downloads.php),\n* [**7.2.14**](http://php.net/downloads.php) and\n* [**7.3.1**](http://php.net/downloads.php).\n\nFixed by [this](https://github.com/php/php-src/commit/a15af81b5f0058e020eda0f109f51a3c863f5212) commit.",
    "severity": "HIGH",
    "cvss2": {
        "baseScore": 5.1,
        "impactSubscore": 6.4,
        "exploitabilitySubscore": 4.9,
        "severity": "MEDIUM",
        "accessVector": "NETWORK",
        "accessComplexity": "HIGH",
        "authentication": "NONE",
        "confidentialityImpact": "PARTIAL",
        "integrityImpact": "PARTIAL",
        "availabilityImpact": "PARTIAL",
        "temporalMetrics": {
            "exploitability": "PROOF_OF_CONCEPT",
            "remediationLevel": "OFFICIAL_FIX",
            "reportConfidence": "CONFIRMED",
            "score": 4.0
        },
        "vector": "(AV:N/AC:H/Au:N/C:P/I:P/A:P/E:POC/RL:OF/RC:C)"
    },
    "cvss3": {
        "baseScore": 8.1,
        "impactSubscore": 5.9,
        "exploitabilitySubscore": 2.2,
        "severity": "HIGH",
        "attackVector": "NETWORK",
        "attackComplexity": "HIGH",
        "confidentialityImpact": "HIGH",
        "integrityImpact": "HIGH",
        "availabilityImpact": "HIGH",
        "privilegesRequired": "NONE",
        "scope": "UNCHANGED",
        "userInteraction": "NONE",
        "temporalMetrics": {
            "exploitability": "PROOF_OF_CONCEPT",
            "remediationLevel": "OFFICIAL_FIX",
            "reportConfidence": "CONFIRMED",
            "score": 7.3
        },
        "vector": "CVSS:3.0/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:H/E:P/RL:O/RC:C"
    },
    "useCvss3": true,
    "classifications": [],
    "zeroDay": false,
    "underReview": false,
    "parentAdvisory": false,
    "credit": "sscannell",
    "workaround": "",
    "vendorFixDate": "2019-01-07T00:00:00.000Z",
    "bdsaTags": [
        "RCE"
    ],
    "overallScore": 7.3,
    "_meta": {
        "allow": [
            "GET"
        ],
        "href": "https://trendmicro2.app.blackduck.com/api/vulnerabilities/BDSA-2019-0250",
        "links": [
            {
                "rel": "cwes",
                "href": "https://trendmicro2.app.blackduck.com/api/cwes/CWE-787"
            },
            {
                "rel": "related-vulnerability",
                "href": "https://trendmicro2.app.blackduck.com/api/vulnerabilities/CVE-2019-6977",
                "label": "NVD"
            },
            {
                "rel": "bdsa-ranges",
                "href": "https://trendmicro2.app.blackduck.com/api/vulnerabilities/BDSA-2019-0250/ranges"
            },
            {
                "rel": "reference",
                "href": "http://php.net/ChangeLog-5.php",
                "label": "ADVISORY"
            },
            {
                "rel": "reference",
                "href": "http://php.net/ChangeLog-7.php",
                "label": "ADVISORY"
            },
            {
                "rel": "reference",
                "href": "http://php.net/downloads.php",
                "label": "VENDOR_UPGRADE"
            },
            {
                "rel": "reference",
                "href": "https://bugs.php.net/bug.php?id=77270",
                "label": "ADVISORY"
            },
            {
                "rel": "reference",
                "href": "https://gist.github.com/cmb69/911de73cc2fbdad85570ea7143455457",
                "label": "POC"
            },
            {
                "rel": "reference",
                "href": "https://github.com/php/php-src/commit/a15af81b5f0058e020eda0f109f51a3c863f5212",
                "label": "PATCH"
            },
            {
                "rel": "reference",
                "href": "https://www.exploit-db.com/docs/english/46460-wordpress-5.0---remote-code-execution.pdf",
                "label": "POC"
            },
            {
                "rel": "default-remediation-status",
                "href": "https://trendmicro2.app.blackduck.com/api/vulnerabilities/BDSA-2019-0250/default-remediation-status"
            }
        ]
    }
}