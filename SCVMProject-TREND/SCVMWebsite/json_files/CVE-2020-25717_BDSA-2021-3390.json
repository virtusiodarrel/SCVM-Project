{
    "source": "BDSA",
    "name": "BDSA-2021-3390",
    "title": "Samba Vulnerable to Privilege Escalation via Account Manipulation within Active Directory Domain",
    "description": "Samba is vulnerable to privilege escalation when it is used within an Active Directory (AD) domain. A privileged attacker could manipulate user account creation and renaming in order to trick Samba's user lookup component into mapping other users (such as `root`) when accepting a Kerberos ticket.",
    "technicalDescription": "When Samba as an AD Domain member accepts a Kerberos ticket, it must map the information found therein to a local UNIX user-id (uid). This is currently done via the account name in the Active Directory generated Kerberos Privileged Attribute Certificate (PAC), or the account name in the ticket (if there is no PAC). This means Samba will attempt to find the user `DOMAIN\\user` before falling back to trying to find the user `user`. An attacker could achieve privilege escalation by creating an account named `root` and then asking for a login without a Kerberos PAC. Before obtaining the ticket and presenting it to the server, the attacker could then rename the account to a different name. Samba's lookup for `DOMAIN\\root` will fail (as this account no longer exists), and the search will fall back to user `root`, which will map to the privileged UNIX uid 0.\n\nThe vulnerability was fixed by requiring a PAC in all scenarios related to active directory domains and using the SID and account name values of the PAC, which means the combination represents the same point in time.\n\nAdditionally, a new parameter has been added (`min domain uid`, default 1000), which does not allow the obtained UNIX user id to be below 1000.",
    "publishedDate": "2021-11-10T12:21:40.533Z",
    "updatedDate": "2021-11-10T12:21:40.519Z",
    "disclosureDate": "2021-11-09T00:00:00.000Z",
    "solution": "Fixed in:\n* [**4.15.2**](https://github.com/samba-team/samba/releases/tag/samba-4.15.2)\n* [**4.14.10**](https://github.com/samba-team/samba/releases/tag/samba-4.14.10)\n* [**4.13.14**](https://github.com/samba-team/samba/releases/tag/samba-4.13.14)\n\nThe latest stable releases can be found [here](https://download.samba.org/pub/samba/).",
    "severity": "HIGH",
    "cvss2": {
        "baseScore": 5.5,
        "impactSubscore": 4.9,
        "exploitabilitySubscore": 8.0,
        "severity": "MEDIUM",
        "accessVector": "NETWORK",
        "accessComplexity": "LOW",
        "authentication": "SINGLE",
        "confidentialityImpact": "PARTIAL",
        "integrityImpact": "PARTIAL",
        "availabilityImpact": "NONE",
        "temporalMetrics": {
            "exploitability": "UNPROVEN",
            "remediationLevel": "OFFICIAL_FIX",
            "reportConfidence": "CONFIRMED",
            "score": 4.0
        },
        "vector": "(AV:N/AC:L/Au:S/C:P/I:P/A:N/E:U/RL:OF/RC:C)"
    },
    "cvss3": {
        "baseScore": 8.1,
        "impactSubscore": 5.2,
        "exploitabilitySubscore": 2.8,
        "severity": "HIGH",
        "attackVector": "NETWORK",
        "attackComplexity": "LOW",
        "confidentialityImpact": "HIGH",
        "integrityImpact": "HIGH",
        "availabilityImpact": "NONE",
        "privilegesRequired": "LOW",
        "scope": "UNCHANGED",
        "userInteraction": "NONE",
        "temporalMetrics": {
            "exploitability": "UNPROVEN",
            "remediationLevel": "OFFICIAL_FIX",
            "reportConfidence": "CONFIRMED",
            "score": 7.1
        },
        "vector": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:N/E:U/RL:O/RC:C"
    },
    "useCvss3": true,
    "classifications": [],
    "zeroDay": false,
    "underReview": false,
    "parentAdvisory": false,
    "credit": "Andrew Bartlett of Catalyst and the Samba Team",
    "workaround": "The vendor provides the following workaround:\n\n> Setting `gensec:require_pac=true` in the `smb.conf` makes the DOMAIN\\user lookup succeed, due to a cache prime in winbind, provided nss_winbind is in use and no error paths are hit.\n\n> It would be prudent to pre-create disabled users in Active Directory matching on all privileged names not held in Active Directory, eg\n```\n samba-tool user add root -H ldap://$SERVER -U$USERNAME%$PASSWORD --random-password\n samba-tool user add ubuntu -H ldap://$SERVER -U$USERNAME%$PASSWORD --random-password\n ...\n```\n> (repeat for eg all system users under 1000 in /etc/passwd or special to any other AD-connected services, eg perhaps \"admin\" for a web-app)\n\n> Setting ms-DS-MachineAccountQuota to 0, in the Active Directory domain is also advised, if possible.\n\n> The following settings might be additional mitigations (but they have not been explicitly verified yet):\n\n> 1. The use of the 'invalid users' option, note this needs to be specified in the `[global]` section, as well as every share with an existing 'invalid users' option, e.g.:\n```\n   invalid users = root, ubuntu\n```\n> 2. The usage of the `obey pam restrictions = yes` together with something like `account required am_succeed_if.so quiet uid >=  1000` in the pam configuration for \"samba\", please consult `man 8 pam_succeed_if`.",
    "vendorFixDate": "2021-11-08T00:00:00.000Z",
    "bdsaTags": [],
    "overallScore": 7.1,
    "_meta": {
        "allow": [
            "GET"
        ],
        "href": "https://trendmicro2.app.blackduck.com/api/vulnerabilities/BDSA-2021-3390",
        "links": [
            {
                "rel": "cwes",
                "href": "https://trendmicro2.app.blackduck.com/api/cwes/CWE-286"
            },
            {
                "rel": "related-vulnerability",
                "href": "https://trendmicro2.app.blackduck.com/api/vulnerabilities/CVE-2020-25717",
                "label": "NVD"
            },
            {
                "rel": "bdsa-ranges",
                "href": "https://trendmicro2.app.blackduck.com/api/vulnerabilities/BDSA-2021-3390/ranges"
            },
            {
                "rel": "reference",
                "href": "https://download.samba.org/pub/samba/",
                "label": "VENDOR_UPGRADE"
            },
            {
                "rel": "reference",
                "href": "https://github.com/samba-team/samba/releases/tag/samba-4.13.14",
                "label": "VENDOR_UPGRADE"
            },
            {
                "rel": "reference",
                "href": "https://github.com/samba-team/samba/releases/tag/samba-4.14.10",
                "label": "VENDOR_UPGRADE"
            },
            {
                "rel": "reference",
                "href": "https://github.com/samba-team/samba/releases/tag/samba-4.15.2",
                "label": "VENDOR_UPGRADE"
            },
            {
                "rel": "reference",
                "href": "https://www.netspi.com/blog/technical/network-penetration-testing/machineaccountquota-is-useful-sometimes",
                "label": "LINK"
            },
            {
                "rel": "reference",
                "href": "https://www.samba.org/samba/security/CVE-2020-25717.html",
                "label": "ADVISORY"
            },
            {
                "rel": "reference",
                "href": "https://www.samba.org/samba/security/CVE-2020-25717.html",
                "label": "WORKAROUND"
            },
            {
                "rel": "default-remediation-status",
                "href": "https://trendmicro2.app.blackduck.com/api/vulnerabilities/BDSA-2021-3390/default-remediation-status"
            }
        ]
    }
}