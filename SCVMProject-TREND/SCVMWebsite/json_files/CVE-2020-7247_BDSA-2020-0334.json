{
    "source": "BDSA",
    "name": "BDSA-2020-0334",
    "title": "OpenSMTPD Vulnerable to Remote Code Execution (RCE) and Local Privilege Escalation via 'smtp_mailaddr' Function",
    "description": "OpenSMTPD mail server, used in OpenBSD, is vulnerable to a remote code execution (RCE) vulnerability due to an incorrectly implemented validation check. An attacker can exploit this to gain local privilege escalation.\n\nThis vulnerability is listed as exploitable by the Cybersecurity & Infrastructure Security Agency in their [Known Exploited Vulnerabilities Catalog](https://www.cisa.gov/known-exploited-vulnerabilities-catalog).",
    "technicalDescription": "This vulnerability exists in the `smtp_mailaddr()` function within the `smtp_session.c` file. It is used to validate both sender and recipient mail addresses by using a whitelist. The `mda_expand_token()` function is also implemented to escape certain unwanted characters. Both these functions are used to prevent execution of Mail Delivery Agent (MDA) commands.\n\nHowever a flaw was found in `smtp_mailaddr()` due to a missing sanity check in cases where the local part of the mail address is invalid and the domain name is empty. As the condition returns as `1` instead of `0`, it results in the bypassing the validation of characters in the local part of the address. This allows for an attacker to include malicious characters to the shell to execute MDA commands.\n\nAn attacker is able to exploit this in two different ways by:\n*  manipulating an `mbox` delivery to execute arbitrary shell commands as root.\n*  leveraging an LMTP delivery to execute arbitrary shell commands as an unauthorized user.",
    "publishedDate": "2020-02-26T16:26:02.434Z",
    "updatedDate": "2022-05-06T14:51:43.813Z",
    "disclosureDate": "2020-01-30T00:00:00.000Z",
    "exploitPublishDate": "2020-01-30T00:00:00.000Z",
    "solution": "Fixed in OpenSMTPD version [**6.6.2p1**](https://github.com/OpenSMTPD/OpenSMTPD/releases/tag/6.6.2p1) by [this](https://github.com/OpenSMTPD/OpenSMTPD/commit/6b988123c35eed1ab6b13f7a4db8e22f2a51bd78) commit. \n\nFixed in OpenBSD [**6.7**](https://cdn.openbsd.org/pub/OpenBSD/6.7/) by [this](https://github.com/openbsd/src/commit/9dcfda045474d8903224d175907bfc29761dcb45) commit.",
    "severity": "CRITICAL",
    "cvss2": {
        "baseScore": 10.0,
        "impactSubscore": 10.0,
        "exploitabilitySubscore": 10.0,
        "severity": "HIGH",
        "accessVector": "NETWORK",
        "accessComplexity": "LOW",
        "authentication": "NONE",
        "confidentialityImpact": "COMPLETE",
        "integrityImpact": "COMPLETE",
        "availabilityImpact": "COMPLETE",
        "temporalMetrics": {
            "exploitability": "FUNCTIONAL",
            "remediationLevel": "OFFICIAL_FIX",
            "reportConfidence": "CONFIRMED",
            "score": 8.3
        },
        "vector": "(AV:N/AC:L/Au:N/C:C/I:C/A:C/E:F/RL:OF/RC:C)"
    },
    "cvss3": {
        "baseScore": 10.0,
        "impactSubscore": 6.0,
        "exploitabilitySubscore": 3.9,
        "severity": "CRITICAL",
        "attackVector": "NETWORK",
        "attackComplexity": "LOW",
        "confidentialityImpact": "HIGH",
        "integrityImpact": "HIGH",
        "availabilityImpact": "HIGH",
        "privilegesRequired": "NONE",
        "scope": "CHANGED",
        "userInteraction": "NONE",
        "temporalMetrics": {
            "exploitability": "FUNCTIONAL",
            "remediationLevel": "OFFICIAL_FIX",
            "reportConfidence": "CONFIRMED",
            "score": 9.3
        },
        "vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H/E:F/RL:O/RC:C"
    },
    "useCvss3": true,
    "classifications": [],
    "zeroDay": false,
    "underReview": false,
    "parentAdvisory": false,
    "credit": "Qualy's",
    "workaround": "",
    "vendorFixDate": "2020-01-28T00:00:00.000Z",
    "bdsaTags": [
        "RCE"
    ],
    "overallScore": 9.3,
    "_meta": {
        "allow": [
            "GET"
        ],
        "href": "https://trendmicro2.app.blackduck.com/api/vulnerabilities/BDSA-2020-0334",
        "links": [
            {
                "rel": "cwes",
                "href": "https://trendmicro2.app.blackduck.com/api/cwes/CWE-358"
            },
            {
                "rel": "cwes",
                "href": "https://trendmicro2.app.blackduck.com/api/cwes/CWE-94"
            },
            {
                "rel": "related-vulnerability",
                "href": "https://trendmicro2.app.blackduck.com/api/vulnerabilities/CVE-2020-7247",
                "label": "NVD"
            },
            {
                "rel": "bdsa-ranges",
                "href": "https://trendmicro2.app.blackduck.com/api/vulnerabilities/BDSA-2020-0334/ranges"
            },
            {
                "rel": "reference",
                "href": "https://cdn.openbsd.org/pub/OpenBSD/6.7/",
                "label": "VENDOR_UPGRADE"
            },
            {
                "rel": "reference",
                "href": "https://github.com/OpenSMTPD/OpenSMTPD/commit/6b988123c35eed1ab6b13f7a4db8e22f2a51bd78",
                "label": "PATCH"
            },
            {
                "rel": "reference",
                "href": "https://github.com/OpenSMTPD/OpenSMTPD/commit/be6ef06cba9484d008d9f057e6b25d863cf278ff#diff-ba5d9f94249bf9b3fefa22a441d22c12",
                "label": "INTRODUCTORY_COMMIT"
            },
            {
                "rel": "reference",
                "href": "https://github.com/OpenSMTPD/OpenSMTPD/releases/tag/6.6.2p1",
                "label": "VENDOR_UPGRADE"
            },
            {
                "rel": "reference",
                "href": "https://github.com/openbsd/src/commit/9dcfda045474d8903224d175907bfc29761dcb45",
                "label": "PATCH"
            },
            {
                "rel": "reference",
                "href": "https://github.com/openbsd/src/commit/a8e222352fecfb8aeaf32faf9d0df59b96a447d0",
                "label": "INTRODUCTORY_COMMIT"
            },
            {
                "rel": "reference",
                "href": "https://www.cisa.gov/known-exploited-vulnerabilities-catalog",
                "label": "EXPLOIT"
            },
            {
                "rel": "reference",
                "href": "https://www.exploit-db.com/exploits/48038",
                "label": "EXPLOIT"
            },
            {
                "rel": "reference",
                "href": "https://www.exploit-db.com/exploits/48051",
                "label": "POC"
            },
            {
                "rel": "reference",
                "href": "https://www.openbsd.org/errata66.html",
                "label": "ADVISORY"
            },
            {
                "rel": "reference",
                "href": "https://www.qualys.com/2020/01/28/cve-2020-7247/lpe-rce-opensmtpd.txt?_ga=2.202345490.2004114369.1582715118-1995036257.1582715118",
                "label": "ADVISORY"
            },
            {
                "rel": "reference",
                "href": "https://www.qualys.com/2020/01/28/cve-2020-7247/lpe-rce-opensmtpd.txt?_ga=2.202345490.2004114369.1582715118-1995036257.1582715118",
                "label": "POC"
            },
            {
                "rel": "default-remediation-status",
                "href": "https://trendmicro2.app.blackduck.com/api/vulnerabilities/BDSA-2020-0334/default-remediation-status"
            }
        ]
    }
}