{
    "source": "BDSA",
    "name": "BDSA-2022-1566",
    "title": "DotCMS Vulnerable to Remote Code Execution (RCE) via Arbitrary File Upload Using Directory Traversal in 'multipartPOST' and 'multipartPUT' Functions",
    "description": "DotCMS contains a directory traversal vulnerability because of improper input validation. A remote attacker could exploit this flaw and upload a malicious file in an arbitrary directory. This could lead to remote code execution (RCE).\n\nThis vulnerability is listed as exploitable by the Cybersecurity & Infrastructure Security Agency in their [Known Exploited Vulnerabilities Catalog](https://www.cisa.gov/known-exploited-vulnerabilities-catalog).",
    "technicalDescription": "This vulnerability stems from a directory traversal flaw in `multipartPOST` and `multipartPUT` functions in `com/dotcms/rest/ContentResource.java` file. These functions process `multipart/form-data` requests for uploading files without validating the file paths first. This can allow a remote attacker to upload files to arbitrary paths. Also, the `processFile()` function in the same file does not validate the file names or file contents when they are being uploaded to the server. Thus, the attacker can upload malicious files and cause arbitrary command execution. As demonstrated in the PoC, the attacker can craft a HTTP POST or HTTP PUT request that leverages the directory traversal vulnerability in order to upload a malicious file `a.jsp` at the following path: `/srv/dotserver/tomcat-9.0.41/webapps/ROOT/html/js/dojo/`. Using the shell obtained via the uploaded file, the attacker can then execute malicious commands on the server.\n\nThis issue was primarily fixed in `dotCMS/src/main/java/com/dotmarketing/util/FileUtil.java` file by implementing a new method `sanitizeFileName` that validates the file names and contents for uploaded files.\n\n**Note**: This vulnerability applies to installations that have `CONTENT_APIS_ALLOW_ANONYMOUS=WRITE` setting enabled in their configurations. This setting is enabled in default configurations.",
    "publishedDate": "2022-06-06T15:42:02.213Z",
    "updatedDate": "2022-08-26T08:18:14.633Z",
    "disclosureDate": "2022-03-28T00:00:00.000Z",
    "exploitPublishDate": "2022-05-03T00:00:00.000Z",
    "solution": "Fixed in:\n* **[5.3.8.10](https://github.com/dotCMS/core/releases/tag/5.3.8.10)** by [this](https://github.com/dotCMS/core/commit/49c2bb7e4eb047be42697e1beee014ffc317360c) commit,\n* **[21.06.7](https://github.com/dotCMS/core/releases/tag/v21.06.7)** by [this](https://github.com/dotCMS/core/commit/a8dedcf32758163836775a7e72e56c7248991e9d) commit,\n* **[22.03](https://github.com/dotCMS/core/releases/tag/v22.03)** by [this](https://github.com/dotCMS/core/commit/f0d746d79e860fe9f7d063d268d8bef4864642d3) commit.\n\nFor users who are not able to upgrade, the vendor has provided the following hotfixes:\n* Users using application versions **5.1.6** and above can apply [this](https://github.com/dotCMS/patches-hotfixes/tree/master/com.dotcms.security.multipartrequest) hotfix.\n* Users using application versions **4.0.0**-**5.1.5** can apply [this](https://github.com/dotCMS/patches-hotfixes/tree/v.4.x/com.dotcms.security.multipartrequest) hotfix.\n\nThe latest stable releases can be found [here](https://github.com/dotCMS/core/tags).",
    "severity": "CRITICAL",
    "cvss2": {
        "baseScore": 7.5,
        "impactSubscore": 6.4,
        "exploitabilitySubscore": 10.0,
        "severity": "MEDIUM",
        "accessVector": "NETWORK",
        "accessComplexity": "LOW",
        "authentication": "NONE",
        "confidentialityImpact": "PARTIAL",
        "integrityImpact": "PARTIAL",
        "availabilityImpact": "PARTIAL",
        "temporalMetrics": {
            "exploitability": "FUNCTIONAL",
            "remediationLevel": "OFFICIAL_FIX",
            "reportConfidence": "CONFIRMED",
            "score": 6.2
        },
        "vector": "(AV:N/AC:L/Au:N/C:P/I:P/A:P/E:F/RL:OF/RC:C)"
    },
    "cvss3": {
        "baseScore": 9.8,
        "impactSubscore": 5.9,
        "exploitabilitySubscore": 3.9,
        "severity": "CRITICAL",
        "attackVector": "NETWORK",
        "attackComplexity": "LOW",
        "confidentialityImpact": "HIGH",
        "integrityImpact": "HIGH",
        "availabilityImpact": "HIGH",
        "privilegesRequired": "NONE",
        "scope": "UNCHANGED",
        "userInteraction": "NONE",
        "temporalMetrics": {
            "exploitability": "FUNCTIONAL",
            "remediationLevel": "OFFICIAL_FIX",
            "reportConfidence": "CONFIRMED",
            "score": 9.1
        },
        "vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H/E:F/RL:O/RC:C"
    },
    "useCvss3": true,
    "classifications": [],
    "zeroDay": false,
    "underReview": false,
    "parentAdvisory": false,
    "credit": "Hussein Daher and Shubham Shah",
    "workaround": "The vendor has stated the following workarounds for this vulnerability:\n* Users can use WAF frameworks to restrict incoming path traversal requests. For instance, AWS WAF has a ruleset `GenericLFI_BODY` that can restrict such requests.\n* A partial mitigation for this flaw would be to use the following configuration settings: `CONTENT_APIS_ALLOW_ANONYMOUS=READ` or `CONTENT_APIS_ALLOW_ANONYMOUS=NONE`. These settings will prevent unknown attackers from exploiting this vulnerability. However, they will not prevent a known/authenticated user from exploiting the vulnerability.",
    "vendorFixDate": "2022-03-04T00:00:00.000Z",
    "vendorNotifiedDate": "2022-02-21T00:00:00.000Z",
    "bdsaTags": [
        "RCE"
    ],
    "overallScore": 9.1,
    "_meta": {
        "allow": [
            "GET"
        ],
        "href": "https://trendmicro2.app.blackduck.com/api/vulnerabilities/BDSA-2022-1566",
        "links": [
            {
                "rel": "cwes",
                "href": "https://trendmicro2.app.blackduck.com/api/cwes/CWE-22"
            },
            {
                "rel": "cwes",
                "href": "https://trendmicro2.app.blackduck.com/api/cwes/CWE-434"
            },
            {
                "rel": "cwes",
                "href": "https://trendmicro2.app.blackduck.com/api/cwes/CWE-77"
            },
            {
                "rel": "related-vulnerability",
                "href": "https://trendmicro2.app.blackduck.com/api/vulnerabilities/CVE-2022-26352",
                "label": "NVD"
            },
            {
                "rel": "bdsa-ranges",
                "href": "https://trendmicro2.app.blackduck.com/api/vulnerabilities/BDSA-2022-1566/ranges"
            },
            {
                "rel": "reference",
                "href": "https://blog.assetnote.io/2022/05/03/dotcms-rce-advisory/",
                "label": "ADVISORY"
            },
            {
                "rel": "reference",
                "href": "https://blog.assetnote.io/2022/05/03/hacking-a-bank-using-dotcms-rce/",
                "label": "POC"
            },
            {
                "rel": "reference",
                "href": "https://github.com/dotCMS/core/commit/49c2bb7e4eb047be42697e1beee014ffc317360c",
                "label": "PATCH"
            },
            {
                "rel": "reference",
                "href": "https://github.com/dotCMS/core/commit/a8dedcf32758163836775a7e72e56c7248991e9d",
                "label": "PATCH"
            },
            {
                "rel": "reference",
                "href": "https://github.com/dotCMS/core/commit/f0d746d79e860fe9f7d063d268d8bef4864642d3",
                "label": "PATCH"
            },
            {
                "rel": "reference",
                "href": "https://github.com/dotCMS/core/releases/tag/5.3.8.10",
                "label": "VENDOR_UPGRADE"
            },
            {
                "rel": "reference",
                "href": "https://github.com/dotCMS/core/releases/tag/v21.06.7",
                "label": "VENDOR_UPGRADE"
            },
            {
                "rel": "reference",
                "href": "https://github.com/dotCMS/core/releases/tag/v22.03",
                "label": "VENDOR_UPGRADE"
            },
            {
                "rel": "reference",
                "href": "https://github.com/dotCMS/core/tags",
                "label": "VENDOR_UPGRADE"
            },
            {
                "rel": "reference",
                "href": "https://github.com/dotCMS/patches-hotfixes/tree/master/com.dotcms.security.multipartrequest",
                "label": "PATCH"
            },
            {
                "rel": "reference",
                "href": "https://github.com/dotCMS/patches-hotfixes/tree/v.4.x/com.dotcms.security.multipartrequest",
                "label": "PATCH"
            },
            {
                "rel": "reference",
                "href": "https://packetstormsecurity.com/files/167365/dotcms_file_upload_rce.rb.txt",
                "label": "EXPLOIT"
            },
            {
                "rel": "reference",
                "href": "https://www.cisa.gov/known-exploited-vulnerabilities-catalog",
                "label": "EXPLOIT"
            },
            {
                "rel": "reference",
                "href": "https://www.dotcms.com/security/SI-62",
                "label": "ADVISORY"
            },
            {
                "rel": "reference",
                "href": "https://www.dotcms.com/security/SI-62",
                "label": "WORKAROUND"
            },
            {
                "rel": "default-remediation-status",
                "href": "https://trendmicro2.app.blackduck.com/api/vulnerabilities/BDSA-2022-1566/default-remediation-status"
            }
        ]
    }
}